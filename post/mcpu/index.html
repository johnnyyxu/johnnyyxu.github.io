<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A 5-stage Pipeline MIPS CPU | Yao Xu</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#f2f2f7;--glass:rgba(255,255,255,.42);--glass-h:rgba(255,255,255,.62);
      --glass-border:rgba(255,255,255,.6);--glass-border-b:rgba(0,0,0,.04);
      --glass-sh:0 1px 3px rgba(0,0,0,.04),0 4px 16px rgba(0,0,0,.05);
      --glass-blur:20px;--glass-spec:rgba(255,255,255,.85);
      --glass-shine:linear-gradient(135deg,rgba(255,255,255,.55) 0%,transparent 42%);
      --nav-bg:rgba(242,242,247,.6);
      --ink:#1d1d1f;--ink-2:#48484a;--ink-3:#8e8e93;--ink-4:#aeaeb2;
      --blue:#0071e3;--code-bg:rgba(0,0,0,.03);
      --sans:'Plus Jakarta Sans',-apple-system,BlinkMacSystemFont,sans-serif;
      --head:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
      --mono:'JetBrains Mono',ui-monospace,monospace;
    }
    @media(prefers-color-scheme:dark){:root:not([data-theme="light"]){
      --bg:#000;--glass:rgba(255,255,255,.05);--glass-h:rgba(255,255,255,.09);
      --glass-border:rgba(255,255,255,.08);--glass-border-b:rgba(255,255,255,.02);
      --glass-sh:0 1px 3px rgba(0,0,0,.2),0 4px 16px rgba(0,0,0,.25),inset 0 .5px 0 rgba(255,255,255,.04);
      --glass-blur:24px;--glass-spec:rgba(255,255,255,.12);
      --glass-shine:linear-gradient(135deg,rgba(255,255,255,.06) 0%,transparent 42%);
      --nav-bg:rgba(0,0,0,.5);
      --ink:#f5f5f7;--ink-2:#a1a1a6;--ink-3:#6e6e73;--ink-4:#48484a;
      --blue:#2997ff;--code-bg:rgba(255,255,255,.05);
    }}
    :root[data-theme="dark"]{
      --bg:#000;--glass:rgba(255,255,255,.05);--glass-h:rgba(255,255,255,.09);
      --glass-border:rgba(255,255,255,.08);--glass-border-b:rgba(255,255,255,.02);
      --glass-sh:0 1px 3px rgba(0,0,0,.2),0 4px 16px rgba(0,0,0,.25),inset 0 .5px 0 rgba(255,255,255,.04);
      --glass-blur:24px;--glass-spec:rgba(255,255,255,.12);
      --glass-shine:linear-gradient(135deg,rgba(255,255,255,.06) 0%,transparent 42%);
      --nav-bg:rgba(0,0,0,.5);
      --ink:#f5f5f7;--ink-2:#a1a1a6;--ink-3:#6e6e73;--ink-4:#48484a;
      --blue:#2997ff;--code-bg:rgba(255,255,255,.05);
    }

    html{scroll-behavior:smooth}
    body{font-family:var(--sans);background:var(--bg);color:var(--ink);
      -webkit-font-smoothing:antialiased;line-height:1.7;overflow-x:hidden;
      transition:background .5s,color .3s}
    ::selection{background:var(--blue);color:#fff}

    body::before{content:'';position:fixed;inset:0;z-index:-1;pointer-events:none;
      background:
        radial-gradient(ellipse 75% 50% at 5% 15%,rgba(0,122,255,.05) 0%,transparent 60%),
        radial-gradient(ellipse 50% 55% at 92% 8%,rgba(175,82,222,.04) 0%,transparent 55%),
        radial-gradient(ellipse 55% 45% at 72% 82%,rgba(52,199,89,.03) 0%,transparent 50%);
    }

    /* Nav */
    nav{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:200;
      width:min(calc(100% - 32px),600px);
      backdrop-filter:blur(28px) saturate(200%);-webkit-backdrop-filter:blur(28px) saturate(200%);
      background:var(--nav-bg);border:1px solid var(--glass-border);
      border-radius:980px;box-shadow:var(--glass-sh);transition:box-shadow .3s}
    nav::before{content:'';position:absolute;top:0;left:18%;right:18%;height:1px;
      background:linear-gradient(90deg,transparent,var(--glass-spec),transparent);pointer-events:none}
    .nv{padding:0 24px;height:46px;display:flex;align-items:center;justify-content:space-between}
    .n-logo{font-family:var(--head);font-size:.95rem;font-weight:600;letter-spacing:-.02em;
      color:var(--ink);text-decoration:none}
    .n-back{font-size:.82rem;color:var(--ink-3);text-decoration:none;
      display:flex;align-items:center;gap:6px;transition:color .2s}
    .n-back:hover{color:var(--ink)}
    .tb{display:flex;align-items:center;justify-content:center;width:32px;height:32px;
      border-radius:50%;border:none;background:none;color:var(--ink-3);cursor:pointer;transition:all .2s}
    .tb:hover{background:var(--glass-h);color:var(--ink)}
    .is{display:none}.im{display:block}
    @media(prefers-color-scheme:dark){
      :root:not([data-theme="light"]) .is{display:block}
      :root:not([data-theme="light"]) .im{display:none}
    }
    :root[data-theme="dark"] .is{display:block}
    :root[data-theme="dark"] .im{display:none}
    :root[data-theme="light"] .is{display:none}
    :root[data-theme="light"] .im{display:block}

    /* Article */
    .art-wrap{max-width:740px;margin:0 auto;padding:100px 24px 80px}
    .art-hd{margin-bottom:40px}
    .art-title{font-family:var(--head);font-size:clamp(1.6rem,4vw,2.2rem);
      font-weight:700;letter-spacing:-.03em;line-height:1.2;margin-bottom:10px}
    .art-meta{font-size:.82rem;color:var(--ink-3)}

    /* Prose */
    .prose h1{font-family:var(--head);font-size:1.5rem;font-weight:700;letter-spacing:-.02em;
      margin:48px 0 16px;line-height:1.3}
    .prose h2{font-family:var(--head);font-size:1.25rem;font-weight:600;letter-spacing:-.02em;
      margin:40px 0 14px;line-height:1.3}
    .prose h3{font-family:var(--head);font-size:1.05rem;font-weight:600;
      margin:32px 0 12px;line-height:1.4}
    .prose p{margin-bottom:18px;color:var(--ink-2)}
    .prose a{color:var(--blue);text-decoration:none}
    .prose a:hover{text-decoration:underline}
    .prose img{max-width:100%;height:auto;border-radius:12px;margin:24px 0;
      box-shadow:var(--glass-sh)}
    .prose figure{margin:24px 0}
    .prose figure img{margin:0}
    .prose ul,.prose ol{margin:0 0 18px 24px;color:var(--ink-2)}
    .prose li{margin-bottom:6px}
    .prose blockquote{border-left:3px solid var(--blue);padding:12px 20px;
      margin:18px 0;background:var(--code-bg);border-radius:0 8px 8px 0;
      color:var(--ink-3)}
    .prose strong{font-weight:600;color:var(--ink)}
    .prose code{font-family:var(--mono);font-size:.85em;background:var(--code-bg);
      padding:2px 6px;border-radius:4px;color:var(--ink-2)}
    .prose pre{background:var(--code-bg);border:1px solid var(--glass-border);
      border-radius:12px;padding:20px 24px;overflow-x:auto;margin:18px 0;
      font-size:.84rem;line-height:1.6}
    .prose pre code{background:none;padding:0;font-size:inherit}
    .prose .highlight pre{background:var(--code-bg);border:1px solid var(--glass-border);
      border-radius:12px;padding:20px 24px;overflow-x:auto;margin:18px 0}
    .prose .highlight code{background:none;padding:0}
    .prose table{width:100%;border-collapse:collapse;margin:18px 0;font-size:.88rem}
    .prose th,.prose td{padding:10px 14px;border-bottom:1px solid var(--glass-border);
      text-align:left}
    .prose th{font-weight:600;color:var(--ink)}

    .art-foot{margin-top:60px;padding-top:24px;border-top:1px solid var(--glass-border);
      text-align:center}
    .art-foot a{font-size:.88rem;color:var(--blue);text-decoration:none}
    .art-foot a:hover{text-decoration:underline}

    @media(max-width:600px){
      .art-wrap{padding:80px 16px 60px}
      .prose pre{padding:14px 16px;border-radius:8px;font-size:.78rem}
    }
  </style>
</head>
<body>

<nav>
  <div class="nv">
    <a href="../../index.html" class="n-logo">Yao Xu</a>
    <div style="display:flex;align-items:center;gap:8px">
      <a href="../../index.html" class="n-back">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        Home
      </a>
      <button class="tb" id="tb" aria-label="Toggle theme">
        <svg class="is" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="im" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </div>
</nav>

<main class="art-wrap">
  <header class="art-hd">
    <h1 class="art-title">A 5-stage Pipeline MIPS CPU</h1>
    <div class="art-meta">Apr 30, 2023 · 5 min read</div>
  </header>
  <div class="prose">
    <h1 id="repo-link">Repo Link</h1>
<p><a href="https://github.com/YaoGH-code/mCPU" target="_blank" rel="noopener">https://github.com/YaoGH-code/mCPU</a></p>
<h1 id="introduction">Introduction</h1>
<p>The MIPS (Microprocessor without Interlocked Pipeline Stages) architecture is a reduced instruction set computer (RISC) architecture that has played a significant role in the development of microprocessors.
MIPS architecture features a clean and streamlined instruction set, emphasizing simplicity and efficiency. It focuses on optimizing the performance of frequently used instructions, making it suitable for a wide range of applications, including embedded systems, consumer electronics, networking equipment, and high-performance computing.</p>
<p>One of the distinguishing characteristics of MIPS is its fixed instruction format, where instructions are encoded in a 32-bit word. This fixed-format allows for efficient decoding and pipelining, enabling high-performance execution and reducing the complexity of the microarchitecture.
MIPS processors employ a five-stage pipeline, including instruction fetch, instruction decode, execution, memory access, and write-back. This pipelining technique enables instructions to be processed concurrently, maximizing the overall throughput of the processor.</p>
<p>















<figure  >
  <img alt="Image alt" 
               src="pipeline.png"
               width="637"
               height="233"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h1 id="design">Design</h1>
<p>The picture above shows the structure and components of this CPU. This CPU is composed of 5 stages, which are: Instruction Fetch(IF), Instruction Decode(ID), Execution(EXE), Memory(MEM) and Write Back(WB) stage.</p>
<h3 id="if-stage">IF Stage</h3>
<p>The Instruction Fetch stage consists of three components. Firstly, there is the program counter register, which holds the physical address of the next instruction in the instruction memory (represented here as a simplified memory structure). In each cycle, an adder increments the address by 4, and the resulting address is stored in the program counter for the next clock cycle. Simultaneously, the instruction memory, equipped with an input port and an output port, fetches an instruction using the address from the program counter. This fetched instruction is then stored in the IF/ID register during the same cycle.</p>
<h3 id="id-stage">ID Stage</h3>
<p>In the instruction decoding stage, we can clearly see the connection between the instruction set and the actual electronic circuit. First, the instruction will be decoded into following components:</p>
<ul>
<li>op code: basic operation of the instruction</li>
<li>rs: the first register source operand</li>
<li>rt: the second register source operand</li>
<li>rd: the register destination operand</li>
<li>shamt: shift amount to be used in shift instructions</li>
<li>funct code: function code</li>
<li>imm: immediate value</li>
</ul>
<p>















<figure  >
  <img alt="Image alt" 
               src="inst.png"
               width="760"
               height="466"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Combining the Op code (bits 31-26) and funct code (bits 5-0) in MIPS instructions enables the hardware to determine the current instruction and its corresponding function. For example, instructions for basic arithmetic operation(R-format) have the same op code 0x0 but
















<figure  >
  <img alt="Image alt" 
               src="format.png"
               width="760"
               height="117"
               loading="lazy" data-zoomable /></div>
  </div></figure>

with a different funct code. So, Op code and funct code combined will be provided to the control unit for generating control signals for later stages. These control signals will be covered later.</p>
<p>There is also a MUX in the MIPS architecture that utilizes the control signal &ldquo;regrt&rdquo; to select either the &ldquo;rd&rdquo; or &ldquo;rt&rdquo; register. The selected signal, along with the data to be written back to the register file, is then passed back to the ID stage. This MUX serves the purpose of determining the appropriate destination for the write-back operation. For instance, instructions with an opcode of 0 will select the &ldquo;rd&rdquo; register as the destination. On the other hand, for the LW (Load Word) instruction, the data retrieved from the data memory during the MEM stage will be written back to the register specified by the &ldquo;rt&rdquo; register. Therefore, the MUX helps decide which part of the instruction contains the desired destination for the write-back operation.</p>
<p>The signals &ldquo;rs&rdquo; and &ldquo;rt&rdquo; are used to access the register file and read the data stored in registers &ldquo;rs&rdquo; and &ldquo;rt&rdquo; simultaneously through the &ldquo;qa&rdquo; and &ldquo;qb&rdquo; ports. Additionally, the immediate value (imm) is sign extended and passed to the ALU for computation. This computation takes place during the EXE stage, where the ALU performs operations using the immediate value and other relevant data.</p>
<p>Then, let&rsquo;s look at the control signals generated by the control unit:</p>
<ul>
<li>wreg: A write back to register will happen in the lifecycle of the current instruction</li>
<li>m2reg: A write back to register with data in memory will happen in the lifecycle of the current instruction</li>
<li>wmem: A write to memory will happen in the lifecycle of the current instruction</li>
<li>aluc: ALU operation mode ex. if aluc==b0010, then ALU_out &lt;= ALU_a + ALU_b;</li>
<li>aluimm: A immediate value is needed by the ALU to finish this operation</li>
</ul>
<h3 id="exe-stage">EXE Stage</h3>
<p>In the EXE (Execute) stage, two signals are employed to control the ALU&rsquo;s input sources and operation mode. Firstly, the &ldquo;ealuc&rdquo; signal is utilized to select the desired operation mode for the ALU. For instance, a value of &ldquo;b0010&rdquo; would indicate that the ALU should perform an addition operation on its two input numbers.</p>
<p>Secondly, the &ldquo;ealuimm&rdquo; signal determines the source of the input port &ldquo;b&rdquo; of the ALU. This is necessary because the number on port &ldquo;b&rdquo; can either come from the register file or be an extended immediate value. The &ldquo;ealuimm&rdquo; signal helps in determining whether the value on port &ldquo;b&rdquo; should be fetched from the register file or be the extended immediate value.</p>
<h3 id="mem-stage">MEM Stage</h3>
<p>During the MEM (Memory) stage, the &ldquo;mwmem&rdquo; signal is employed to determine whether the current instruction requires writing to the data memory or not. If the &ldquo;mwmem&rdquo; signal is set to indicate a write operation, the value from input port &ldquo;a&rdquo; will be written to the memory address specified by the value on input port &ldquo;di&rdquo;. On the other hand, if the &ldquo;mwmem&rdquo; signal indicates a read operation, the word at the memory address specified by the value on input port &ldquo;di&rdquo; will be retrieved and passed to the output port of the data memory. The &ldquo;mwmem&rdquo; signal thus controls the write or read operation on the data memory based on the instruction&rsquo;s requirements.</p>
<h3 id="wb-stage">WB Stage</h3>
<p>In the final stage of the MIPS pipeline, the &ldquo;wm2reg&rdquo; (also referred to as &ldquo;em2reg&rdquo;) signal is employed as a selector for a MUX. This MUX determines whether the result obtained from the ALU computation or the data recently read from the data memory during the MEM stage will be chosen for writing back to the register file. The &ldquo;wm2reg&rdquo; signal serves as the control signal for this MUX, enabling the selection of the appropriate data to be written back based on the pipeline stage&rsquo;s requirements.</p>
<h1 id="testing">Testing</h1>
<p>RTL design:
















<figure  >
  <img alt="Image alt" 
               src="RTL.png"
               width="695"
               height="365"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>Output waveform of executing following instructions:</p>
<ul>
<li>32&rsquo;b10001100001000100000000000000000; -&gt; lw $2, 00($1)</li>
<li>32&rsquo;b10001100001000110000000000000100; -&gt; lw $3, 04($1)</li>
<li>32&rsquo;b10001100001001000000000000001000; -&gt; lw $4, 08($1)</li>
<li>32&rsquo;b10001100001001010000000000001100; -&gt; lw $5, 12($1)</li>
<li>32&rsquo;b00000000010010100011000000100000; -&gt; add $6, $2, $10
















<figure  >
  <img alt="Image alt" 
               src="WF.png"
               width="760"
               height="418"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</li>
</ul>
  </div>
  <div class="art-foot">
    <a href="../../index.html">← Back to Home</a>
  </div>
</main>

<script>
const r=document.documentElement,s=localStorage.getItem('theme');
if(s)r.setAttribute('data-theme',s);
document.getElementById('tb').onclick=()=>{
  const c=r.getAttribute('data-theme'),d=matchMedia('(prefers-color-scheme:dark)').matches,
  n=!c?(d?'light':'dark'):c==='dark'?'light':'dark';
  r.setAttribute('data-theme',n);localStorage.setItem('theme',n)};
</script>
</body>
</html>